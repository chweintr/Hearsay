<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Room 412 ‚Äî HEARSAY</title>
    <meta name="description" content="Stories through the door. A HEARSAY experience.">
    
    <link rel="stylesheet" href="styles.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=EB+Garamond:ital,wght@0,400;0,500;0,600;1,400;1,500&family=Cinzel:wght@400;500;600&display=swap" rel="stylesheet">
    
    <!-- Simli Widget SDK -->
    <script src="https://app.simli.com/simli-widget/index.js" defer></script>
</head>
<body>
    <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
         ENTRY PAGE - Intro Video
         ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
    <div id="entry-page" class="page active">
        <!-- STAGE 1: Full-screen ambient video with Click to Begin -->
        <div id="entry-stage-1" class="entry-stage">
            <video id="entry-video-bg" class="entry-video-fullscreen" autoplay loop muted playsinline>
                <source src="assets/videos/Landing_1080.mp4" type="video/mp4">
            </video>
            <div id="click-to-start" class="click-to-start-overlay">
                <div class="click-to-start-content">
                    <span class="start-text">Click to Begin</span>
                </div>
            </div>
        </div>
        
        <!-- STAGE 2: Letterbox video with sound + controls -->
        <div id="entry-stage-2" class="entry-stage hidden">
            <div class="entry-letterbox-container">
                <video id="entry-video" class="entry-video-letterbox" playsinline>
                    <source src="assets/videos/Landing_1080.mp4" type="video/mp4">
                </video>
            </div>
            <button id="enter-btn" class="enter-button hidden">Enter</button>
            <button id="skip-intro-btn" class="skip-intro-btn">Skip</button>
        </div>
    </div>

    <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
         LANDING PAGE - Character Selection
         ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
    <div id="landing-page" class="page hidden">
        <!-- Video stack - both videos in same container for blend mode to work -->
        <div class="video-blend-stack">
            <video id="landing-video" class="landing-bg-video" autoplay muted playsinline>
                <source src="assets/videos/The_Knock_Background.mp4" type="video/mp4">
            </video>
            <!-- Animated text overlay - same parent so screen blend works -->
            <video id="animated-text-video" class="animated-text-video" autoplay loop muted playsinline>
                <source src="assets/videos/Animated_Text.mp4" type="video/mp4">
            </video>
        </div>
        <div class="landing-overlay"></div>
        
        <div class="landing-content">
            <div class="landing-spacer"></div>
            
            <div class="character-gallery" id="character-gallery">
                <!-- Characters injected by JS -->
            </div>
            
            <div class="menu-buttons">
                <button id="about-btn" class="menu-btn">About</button>
                <button id="store-btn" class="menu-btn">Sensory Packs</button>
                <button id="chapters-btn" class="menu-btn chapters-btn hidden">Your Story</button>
                <button id="end-session-btn" class="menu-btn session-btn hidden">End Session</button>
            </div>
            
            <!-- Session indicator - shows conversation count -->
            <div id="session-indicator" class="session-indicator hidden">
                <span id="session-count">0</span> conversation<span id="session-plural">s</span> tonight
            </div>
        </div>
    </div>
    
    <!-- Coming Soon Modal -->
    <div id="coming-soon-modal" class="modal hidden">
        <div class="modal-content coming-soon-content">
            <button class="modal-close" onclick="document.getElementById('coming-soon-modal').classList.add('hidden')">&times;</button>
            <h2><span class="coming-soon-name">This character</span> is not yet available</h2>
            <p>The hotel is still preparing their room. Leave your details and we'll let you know when they're ready to receive visitors.</p>
            <form class="waitlist-form" onsubmit="event.preventDefault(); submitWaitlist(this);">
                <input type="email" name="email" placeholder="your@email.com" required>
                <button type="submit">Notify Me</button>
            </form>
        </div>
    </div>
    
    <!-- Store Modal -->
    <div id="store-modal" class="modal hidden">
        <div class="modal-content store-content">
            <button class="modal-close" onclick="document.getElementById('store-modal').classList.add('hidden')">&times;</button>
            
            <!-- Store Header with Heraldic Image -->
            <div class="store-header">
                <img src="assets/images/Heraldic_Bigger.png" alt="The Knock Crest" class="store-crest">
                <h1 class="store-title">The Hotel Provisions</h1>
            </div>
            
            <!-- Audio Controls in Store -->
            <div class="store-audio-controls">
                <button id="store-audio-toggle" class="audio-toggle-mini">üîä</button>
                <div class="volume-sliders-mini">
                    <label>Ambient</label>
                    <input type="range" id="store-ambient-volume" min="0" max="100" value="65">
                    <label>Music</label>
                    <input type="range" id="store-music-volume" min="0" max="100" value="15">
                    <button id="store-mute-btn" class="mute-btn-mini">Mute</button>
                </div>
            </div>
            
            <h2>Sensory Packs</h2>
            <p class="store-tagline">Physical artifacts from the hotel. Things you can hold, smell, taste. The fiction made tangible.</p>
            
            <div class="store-grid" id="store-grid">
                <!-- Products injected by JS -->
            </div>
            
            <!-- BAR GUIDE - Full mixing instructions -->
            <div class="bar-guide-section">
                <h2>üç∏ The Bar Guide</h2>
                <p class="bar-tagline">What the residents drink. Mix at home while you talk to them.</p>
                <div class="bar-guide-grid" id="bar-guide-grid">
                    <!-- Drinks injected by JS -->
                </div>
            </div>
            
            <p class="store-notice">
                <strong>THE KNOCK</strong> brought to you by <em>Past Presence</em> is currently in development.<br>
                Leave your email to be notified when the hotel opens its doors.
            </p>
            <form class="waitlist-form" onsubmit="event.preventDefault(); submitWaitlist(this);">
                <input type="email" name="email" placeholder="your@email.com" required>
                <button type="submit">Join Waitlist</button>
            </form>
        </div>
    </div>
    
    <!-- About Modal -->
    <div id="about-modal" class="modal hidden">
        <div class="modal-content">
            <button class="modal-close" id="about-close">√ó</button>
            <div class="about-text">
                <p class="about-lead">Someone is at your door.</p>
                <p>They have something to tell you. Whether you believe them is up to you.</p>
                <p>HEARSAY is a series of conversational experiences. No puzzles. No right answers. Just unreliable narrators and the stories they tell.</p>
                <p class="about-tagline">Somewhere between a novel, a play, a movie, a mystery, a dream, a confession, and a communion.</p>
            </div>
        </div>
    </div>
    
    <!-- Writing Engine Modal -->
    <div id="writing-modal" class="modal hidden">
        <div class="modal-content writing-modal-content">
            <button class="modal-close" id="writing-close">√ó</button>
            
            <!-- Loading State -->
            <div id="writing-loading" class="writing-state">
                <div class="writing-spinner"></div>
                <h2>Writing your chapter...</h2>
                <p>Claude is weaving your conversations into prose.</p>
                <p class="writing-hint">This may take 30-60 seconds.</p>
            </div>
            
            <!-- Success State -->
            <div id="writing-success" class="writing-state hidden">
                <h2>Your Chapter</h2>
                <div id="chapter-content" class="chapter-content"></div>
                <div class="chapter-meta">
                    <span id="chapter-word-count"></span> words
                    <span class="meta-sep">‚Ä¢</span>
                    <span id="chapter-characters"></span>
                </div>
                <div class="chapter-actions">
                    <button id="copy-chapter-btn" class="menu-btn">Copy to Clipboard</button>
                    <button id="new-session-btn" class="menu-btn">Start New Session</button>
                </div>
            </div>
            
            <!-- Error State -->
            <div id="writing-error" class="writing-state hidden">
                <h2>Something went wrong</h2>
                <p id="writing-error-message">Unable to generate chapter.</p>
                <button id="retry-chapter-btn" class="menu-btn">Try Again</button>
            </div>
        </div>
    </div>
    
    <!-- Chapters Modal (Your Story) -->
    <div id="chapters-modal" class="modal hidden">
        <div class="modal-content chapters-modal-content">
            <button class="modal-close" id="chapters-close">√ó</button>
            
            <div class="chapters-header">
                <h1>Your Story So Far</h1>
                <p class="chapters-tagline">The nights you've spent at Room 412, rendered in prose.</p>
            </div>
            
            <!-- No chapters state -->
            <div id="chapters-empty" class="chapters-empty">
                <p>No chapters yet.</p>
                <p class="chapters-hint">Talk to the residents, then click "End Session" to generate your first chapter.</p>
            </div>
            
            <!-- Chapters list -->
            <div id="chapters-list" class="chapters-list hidden">
                <!-- Chapters injected by JS -->
            </div>
            
            <!-- Chapter reader -->
            <div id="chapter-reader" class="chapter-reader hidden">
                <button id="back-to-chapters" class="menu-btn back-btn">‚Üê Back to Chapters</button>
                <div class="reader-header">
                    <h2 id="reader-title">Chapter 1</h2>
                    <div class="reader-meta">
                        <span id="reader-date"></span>
                        <span class="meta-sep">‚Ä¢</span>
                        <span id="reader-words"></span> words
                        <span class="meta-sep">‚Ä¢</span>
                        <span id="reader-characters"></span>
                    </div>
                </div>
                <div id="reader-content" class="reader-content"></div>
                <div class="reader-actions">
                    <button id="reader-copy-btn" class="menu-btn">Copy to Clipboard</button>
                </div>
            </div>
        </div>
    </div>

    <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
         EXPERIENCE PAGE - Peephole Interface
         ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
    <div id="experience-page" class="page">
        <div id="hearsay-app">
            <!-- Layer 0: Hallway Background - always visible, full screen -->
            <div id="layer-background" class="video-layer">
                <video id="video-hallway" loop muted playsinline autoplay>
                    <source src="assets/videos/Background_1.mp4" type="video/mp4">
                </video>
            </div>

            <!-- Face Container: shared mount for walkup videos AND Simli -->
            <!-- This is centered in the peephole, sized to fit the opening -->
            <div id="face-container">
                <!-- Layer 1: Transition/Walkup Videos -->
                <div id="layer-transition" class="face-layer hidden">
                    <video id="video-transition" muted playsinline></video>
                </div>

                <!-- Layer 2: Simli Widget -->
                <div id="layer-simli" class="face-layer hidden">
                    <div id="simli-mount"></div>
                </div>
            </div>

            <!-- Layer 3: Peephole Frame -->
            <div id="layer-peephole" class="overlay-layer">
                <div id="peephole-mask">
                    <div id="peephole-glass"></div>
                </div>
            </div>

            <!-- Layer 4: Peephole overlay - full screen with transparent center -->
            <div id="layer-door-overlay" class="overlay-layer">
                <img src="assets/images/overlay.png" alt="" id="peephole-overlay">
            </div>

            <!-- Vignette -->
            <div id="vignette-overlay"></div>
        </div>

        <!-- Experience Controls -->
        <div id="experience-controls" class="experience-ui">
            <button id="btn-dismiss" class="btn-dismiss" disabled>Send Away</button>
            <button id="btn-back" class="btn-back">‚Üê Back</button>
        </div>

        <!-- Character info overlay -->
        <div id="character-info" class="character-info">
            <span id="current-character-name"></span>
            <span id="current-character-role"></span>
        </div>
    </div>

    <!-- Audio elements -->
    <audio id="audio-knock" preload="auto">
        <source src="assets/sounds/door_knocks/knock_hotel_1.wav" type="audio/wav">
    </audio>
    
    <!-- Ambient track - single loop -->
    <audio id="ambient-main" class="ambient-track" loop preload="auto">
        <source src="assets/sounds/hotel_hallway_subtle_3a.wav" type="audio/wav">
    </audio>
    
    <!-- Music tracks - rotate between them -->
    <audio id="music-main" class="music-track" loop preload="auto">
        <!-- Source set dynamically by JS -->
    </audio>
    
    <!-- Audio Controls -->
    <div id="audio-controls" class="audio-controls">
        <button id="audio-toggle" class="audio-toggle">üîä</button>
        <div class="volume-sliders">
            <div class="slider-group">
                <label>Ambient</label>
                <input type="range" id="ambient-volume" min="0" max="100" value="65">
            </div>
            <div class="slider-group">
                <label>Music</label>
                <input type="range" id="music-volume" min="0" max="100" value="15">
            </div>
            <button id="mute-all-btn" class="mute-btn">Mute All</button>
        </div>
    </div>

    <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
         APPLICATION LOGIC
         ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
    <script type="module">
        import { config, characters, platform, experience } from './config.js';
        import { StateMachine } from './state-machine.js';
        import { Compositor } from './compositor.js';
        import { SimliIntegration } from './simli-integration.js';
        import { getSessionManager } from './session-manager.js';

        // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        // PAGE MANAGEMENT
        // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        
        const entryPage = document.getElementById('entry-page');
        const landingPage = document.getElementById('landing-page');
        const experiencePage = document.getElementById('experience-page');
        const enterBtn = document.getElementById('enter-btn');
        const entryVideo = document.getElementById('entry-video');
        const entryVideoBg = document.getElementById('entry-video-bg');
        const skipIntroBtn = document.getElementById('skip-intro-btn');
        const clickToStart = document.getElementById('click-to-start');
        const entryStage1 = document.getElementById('entry-stage-1');
        const entryStage2 = document.getElementById('entry-stage-2');
        
        // Click to start: transition from Stage 1 (fullscreen) to Stage 2 (letterbox)
        clickToStart?.addEventListener('click', () => {
            // Hide Stage 1, show Stage 2
            entryStage1?.classList.add('hidden');
            entryStage2?.classList.remove('hidden');
            
            // Start video from beginning with sound
            if (entryVideo) {
                entryVideo.currentTime = 0;
                entryVideo.muted = false;
                entryVideo.play().catch(e => console.log('Video play blocked:', e));
            }
        });
        
        // Show Enter button when video ends
        function showEnterButton() {
            entryVideo?.classList.add('faded');
            enterBtn?.classList.remove('hidden');
            skipIntroBtn?.classList.add('hidden');
        }
        
        if (entryVideo) {
            entryVideo.addEventListener('ended', showEnterButton);
        }
        
        // Skip button
        skipIntroBtn?.addEventListener('click', () => {
            entryVideo?.pause();
            showEnterButton();
        });
        
        function showEntry() {
            entryPage.classList.add('active');
            landingPage.classList.remove('active');
            experiencePage.classList.remove('active');
        }
        
        function showLanding() {
            entryPage.classList.remove('active');
            landingPage.classList.add('active');
            experiencePage.classList.remove('active');
            // Rotate music when returning to landing
            if (typeof nextMusicTrack === 'function') {
                nextMusicTrack();
            }
        }
        
        function showExperience() {
            entryPage.classList.remove('active');
            landingPage.classList.remove('active');
            experiencePage.classList.add('active');
        }
        
        // Entry page ‚Üí Landing page transition
        enterBtn?.addEventListener('click', () => {
            // Fade out entry, fade in landing
            entryPage.classList.add('fading-out');
            setTimeout(() => {
                showLanding();
                entryPage.classList.remove('fading-out');
                // Start audio when entering (user interaction)
                const ambient = document.getElementById('ambient-audio');
                const music = document.getElementById('music-audio');
                ambient?.play().catch(() => {});
                music?.play().catch(() => {});
            }, 800);
        });

        // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        // CHARACTER GALLERY
        // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        
        const gallery = document.getElementById('character-gallery');
        const characterKeys = Object.keys(characters);
        const totalChars = characterKeys.length;
        
        // Orbital positioning - characters arranged around the peephole
        // Start at 120¬∞ (lower left), go to 420¬∞ (lower right), avoiding top where title is
        // This creates a horseshoe shape around the bottom/sides
        const startAngle = 120;
        const endAngle = 420; // 420 = 60¬∞ on the right side
        const angleStep = (endAngle - startAngle) / (totalChars - 1);
        
        characterKeys.forEach((key, index) => {
            const character = characters[key];
            const card = document.createElement('div');
            card.className = 'character-card';
            card.dataset.character = key;
            
            // Add coming_soon class if not ready
            if (character.status === 'coming_soon') {
                card.classList.add('coming-soon');
            }
            
            // Calculate radial position
            const angle = startAngle + (index * angleStep);
            card.style.setProperty('--angle', `${angle}deg`);
            card.dataset.angle = angle;
            
            // Check if we have a preview video
            const videoSrc = character.previewVideo || 
                (character.idleToActive && character.idleToActive.length > 0 ? character.idleToActive[0] : null);
            
            card.innerHTML = `
                <div class="character-circle">
                    ${videoSrc ? `
                        <video class="character-preview" loop muted playsinline autoplay>
                            <source src="${videoSrc}" type="video/mp4">
                        </video>
                    ` : `
                        <div class="character-placeholder">
                            <span class="placeholder-initial">${character.name.charAt(0)}</span>
                        </div>
                    `}
                    <div class="character-circle-border"></div>
                    ${character.status === 'coming_soon' ? '<div class="coming-soon-badge">Coming Soon</div>' : ''}
                </div>
                <span class="character-name">${character.name}</span>
                <span class="character-role">${character.role}</span>
            `;
            
            card.addEventListener('click', () => {
                if (character.status === 'coming_soon') {
                    showComingSoonModal(character.name);
                } else {
                    enterExperience(key);
                }
            });
            
            // Play video on hover
            const video = card.querySelector('video');
            if (video) {
                video.play().catch(() => {});
            }
            
            gallery.appendChild(card);
        });
        
        // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        // ORBIT ANIMATION (Slow rotary phone effect)
        // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        
        (function initOrbitAnimation() {
            let orbitOffset = 0;
            let isPaused = false;
            const ROTATION_SPEED = 0.012; // degrees per frame (~90 seconds for full rotation at 60fps)
            const cards = gallery.querySelectorAll('.character-card');
            
            // Pause on hover over any card
            cards.forEach(card => {
                card.addEventListener('mouseenter', () => { isPaused = true; });
                card.addEventListener('mouseleave', () => { isPaused = false; });
            });
            
            function animateOrbit() {
                if (!isPaused) {
                    orbitOffset += ROTATION_SPEED;
                    if (orbitOffset >= 360) orbitOffset -= 360;
                    // Apply to each card directly for reliable inheritance
                    cards.forEach(card => {
                        card.style.setProperty('--orbit-offset', `${orbitOffset}deg`);
                    });
                }
                requestAnimationFrame(animateOrbit);
            }
            
            // Start the animation
            requestAnimationFrame(animateOrbit);
        })();
        
        // Coming Soon Modal
        function showComingSoonModal(charName) {
            const modal = document.getElementById('coming-soon-modal');
            const nameEl = modal.querySelector('.coming-soon-name');
            if (nameEl) nameEl.textContent = charName;
            modal.classList.remove('hidden');
        }

        // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        // CORE SYSTEMS
        // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        
        const stateMachine = new StateMachine();
        const compositor = new Compositor(stateMachine);
        const simli = new SimliIntegration(stateMachine, config);
        
        // UI Elements
        const dismissBtn = document.getElementById('btn-dismiss');
        const backBtn = document.getElementById('btn-back');
        const charNameEl = document.getElementById('current-character-name');
        const charRoleEl = document.getElementById('current-character-role');

        // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        // ENTER EXPERIENCE
        // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        
        function enterExperience(characterKey) {
            const character = characters[characterKey];
            if (!character) return;
            
            // Update character info display
            charNameEl.textContent = character.name;
            charRoleEl.textContent = character.role;
            
            // Switch to experience view
            showExperience();
            
            // Start the experience - summon character
            setTimeout(() => {
                stateMachine.summonCharacter(characterKey);
            }, 500);
        }

        // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        // CONTROLS
        // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        
        dismissBtn.addEventListener('click', () => {
            if (stateMachine.currentState === 'active') {
                stateMachine.dismissCharacter();
            }
        });
        
        backBtn.addEventListener('click', () => {
            // If in conversation, dismiss first
            if (stateMachine.currentState === 'active') {
                stateMachine.dismissCharacter();
            }
            // Go back to landing after a moment
            setTimeout(() => {
                stateMachine.reset();
                showLanding();
            }, 300);
        });

        // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        // STATE UPDATES
        // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        
        stateMachine.on('stateChange', ({ to }) => {
            dismissBtn.disabled = to !== 'active';
        });
        
        stateMachine.on('characterDismissed', () => {
            // Return to landing after character leaves
            setTimeout(() => {
                showLanding();
            }, 500);
        });

        // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        // INIT
        // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        
        // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        // ABOUT MODAL
        // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        
        const aboutBtn = document.getElementById('about-btn');
        const aboutModal = document.getElementById('about-modal');
        const aboutClose = document.getElementById('about-close');
        
        aboutBtn?.addEventListener('click', () => {
            aboutModal?.classList.remove('hidden');
        });
        
        aboutClose?.addEventListener('click', () => {
            aboutModal?.classList.add('hidden');
        });
        
        aboutModal?.addEventListener('click', (e) => {
            if (e.target === aboutModal) {
                aboutModal.classList.add('hidden');
            }
        });

        // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        // STORE MODAL
        // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        
        const storeBtn = document.getElementById('store-btn');
        const storeModal = document.getElementById('store-modal');
        const storeGrid = document.getElementById('store-grid');
        
        // Sensory Pack Products - 9 characters + Hotel sampler
        const storeProducts = [
            {
                id: 'tane',
                name: 'TANE ‚Äî "Live Fast"',
                tagline: 'We\'ll show you what you\'re hiding.',
                price: '$35',
                images: [
                    'assets/images/Sensory Packs/Sensory_Tane_Vertical.jpeg',
                    'assets/images/Sensory Packs/sensory_Tane_Good.png',
                    'assets/images/Sensory Packs/Sensory_Pack_Tane_2.png'
                ],
                image: 'assets/images/Sensory Packs/Sensory_Tane_Vertical.jpeg',
                storeVideo: 'assets/videos/Tane_Store.mp4',
                featured: true,
                description: 'The box glows like a bad idea at 2am. Open it and remember what ambition smelled like before it learned consequences.',
                contents: [
                    'Energy drink powder ("MIX WITH VODKA OR REGRET")',
                    '"GOLDEN TEACHER" bubblegum ‚Äî tastes like enlightenment, chew responsibly',
                    'Temporary tattoo sheet ‚Äî horse, "LONG ODDS", anatomical heart',
                    '"PULSE" cologne ‚Äî synthetic musk, pheromones, rubber accord, patchouli, castoreum, sandalwood, petrichor',
                    '"THE STARTING GATE" matchbook',
                    'Scratch-off fortune cards',
                    'Submission card ‚Äî "Send us your face." (Trust us.)',
                    'Polaroids from an evening you don\'t remember',
                    'Sticky note ‚Äî handwriting not yours'
                ],
                cocktail: 'Energy drink vodka shot',
                virgin: 'Energy drink straight'
            },
            {
                id: 'wire',
                name: 'WIRE ‚Äî "The Sixth Floor"',
                tagline: 'For patience. Steep until you understand.',
                price: '$35',
                image: null,
                description: 'Arrives wrapped in brown paper like a secret. Smells of old wood and patience. Some things take longer to understand.',
                contents: [
                    'Kawakawa & mƒÅnuka honey tea blend',
                    'Vintage sugar cubes in tin',
                    'Racing form guide ‚Äî hand-annotated',
                    'Sandalwood & petrichor scent',
                    'Brass key "614"',
                    'Huia feather replica',
                    'Sticky note ‚Äî "He knows more than he says"'
                ],
                cocktail: 'Hot Toddy with mƒÅnuka honey',
                virgin: 'Tea-based toddy'
            },
            {
                id: 'marisol',
                name: 'MARISOL ‚Äî "The Inheritance"',
                tagline: 'What he knew. What he didn\'t tell me.',
                price: '$35',
                images: [
                    'assets/images/Sensory Packs/Sensory_Marisol_vertical.png',
                    'assets/images/Sensory Packs/Sensory_Marisol.png',
                    'assets/images/Sensory Packs/Sensory_Marisol.2.png'
                ],
                description: 'Sealed with her family crest. Inside: the things daughters inherit when fathers die badly. Some assembly required.',
                contents: [
                    'Brass key ‚Äî room number scratched off',
                    'Wax seal kit with Vance crest',
                    'Two scent vials: "HER" and "THE DISGUISE"',
                    'Theatrical false lashes',
                    'False mustache ‚Äî the incognito kind',
                    'Redacted legal document',
                    'Polaroid ‚Äî figure in fourth floor window',
                    'Sticky note ‚Äî "Don\'t trust the daughter"'
                ],
                cocktail: 'Dark & Stormy',
                virgin: 'Ginger lime spritz'
            },
            {
                id: 'eddie',
                name: 'EDDIE ‚Äî "The Night Kitchen"',
                tagline: 'For when you can\'t sleep. Make this. Feel better.',
                price: '$35',
                image: null,
                description: 'Warm before you open it. The remedy for 3am hunger, loneliness, and questions you can\'t ask in daylight.',
                contents: [
                    'Mole spice blend in clay pot',
                    'Tamarind candies (Pulparindo style)',
                    'Loter√≠a cards: La Luna, El Coraz√≥n, La Muerte',
                    'Mexican vanilla from Papantla',
                    'Kitchen scent ‚Äî tortilla, woodsmoke, cumin',
                    'Champurrado recipe card',
                    'Sticky note ‚Äî "He saw something that night"'
                ],
                cocktail: 'Michelada',
                virgin: 'Virgin michelada'
            },
            {
                id: 'dotty',
                name: 'DOTTY ‚Äî "Room 308"',
                tagline: 'She was somebody once.',
                price: '$35',
                image: null,
                description: 'Smells like 1962 and regrets she doesn\'t have. Contains everything a woman needs to have been beautiful.',
                contents: [
                    'Horehound drops in dented silver tin',
                    'Mini bottle labeled "MEDICINAL PURPOSES"',
                    'Gin botanical sachet',
                    'Lipstick-stained cocktail napkin',
                    'Tarnished compact mirror, initialed "D.M."',
                    'B&W photograph ‚Äî beautiful woman, 1960s',
                    'Sticky note ‚Äî "She remembers everything"'
                ],
                cocktail: 'Gin Fizz',
                virgin: 'Botanical lemonade fizz'
            },
            {
                id: 'constance',
                name: 'CONSTANCE ‚Äî "Fourth Floor"',
                tagline: 'Observed. Noted. Filed.',
                price: '$35',
                image: null,
                description: 'Arrives precisely. Contains the tools of someone who watches. You\'ll want to meet her standards.',
                contents: [
                    'Pressed flowers from the hotel garden',
                    'Calling card ‚Äî just her name, no contact',
                    'Green aldehydic perfume sample',
                    'Note: "I know why you\'re here. Do you?"',
                    'Brass magnifying glass',
                    'Vintage bookplate ‚Äî name scratched out',
                    'Sticky note ‚Äî "Fourth floor. After midnight."'
                ],
                cocktail: 'Pimm\'s Cup',
                virgin: 'Cucumber mint lemonade'
            },
            {
                id: 'priya',
                name: 'PRIYA ‚Äî "Trust Me"',
                tagline: 'What happens at the bar stays at the bar. Mostly.',
                price: '$35',
                image: null,
                description: 'The bartender knows everything. This is what she carries. Bitter, complicated, worth the trouble.',
                contents: [
                    'Bar towel embroidered "P.R."',
                    'Mismatched cocktail stirrers',
                    'Bitters sampler ‚Äî numbered 1, 2, 3',
                    'Hotel bar matchbook',
                    'Scent: fernet, mezcal, citrus peel',
                    'Ceramic olive (joke or keepsake, unclear)',
                    'Sticky note ‚Äî "Ask about the tab"'
                ],
                cocktail: 'The Trust Me ‚Äî fernet & mezcal',
                virgin: 'Bitter botanical soda with grapefruit'
            },
            {
                id: 'lenny',
                name: 'LENNY ‚Äî "The Comedian"',
                tagline: 'Thank you, you\'ve been a beautiful audience.',
                price: '$35',
                image: null,
                description: 'Looks like it\'s been through a few tours. Smells like rental cars and mints that aren\'t fooling anyone. Funny in a way that hurts.',
                contents: [
                    '"LAUGH TRACK LOUNGE" matchbook',
                    'Cheap breath mints in dented tin',
                    'Mini whiskey bottle (maybe refilled)',
                    'Crumpled setlist ‚Äî "hotel bit ‚Äî too real?"',
                    'Motel soap from "The Restwell"',
                    'Fake business card ‚Äî numbers crossed out',
                    'Sticky note ‚Äî "His jokes aren\'t jokes"'
                ],
                cocktail: 'Irish Coffee',
                virgin: 'Just sad coffee'
            },
            {
                id: 'caleb',
                name: 'CALEB ‚Äî "The Author"',
                tagline: 'I made this. I\'m still not sure why.',
                price: '$35',
                image: null,
                description: 'From the person who made all the others. Meta, yes. But also: real tools for making sense of fiction. Handle with curiosity.',
                contents: [
                    'Polaroid ‚Äî author\'s workspace',
                    'Handwritten note about the characters',
                    'Used paintbrush, bristles stained',
                    'Studio scent: linseed oil, turpentine, coffee',
                    'Exhibition postcard',
                    'Blank notebook for your notes',
                    'Sticky note ‚Äî "Who wrote this?"'
                ],
                cocktail: 'Bourbon neat',
                virgin: 'Black coffee'
            },
            {
                id: 'rufus',
                name: 'RUFUS ‚Äî "The Performance"',
                tagline: 'I\'m not one to gossip, BUT‚Äî',
                price: '$35',
                image: null,
                description: 'Red velvet packaging. Smells of greasepaint and champagne. Contains everything you need to watch and be watched. The clown sees all.',
                contents: [
                    'Red foam clown nose',
                    'Miniature Elizabethan ruff ‚Äî stiff white lace',
                    'Theatrical makeup compact ‚Äî greasepaint and rouge',
                    'Dried rose petals ‚Äî from a bouquet or a funeral',
                    'Glass bottle labeled "TEARS (GLYCERIN)"',
                    'Polaroid ‚Äî party, faces scratched out',
                    'Miniature opera glasses ‚Äî gold and mother of pearl',
                    'Scent: champagne, powder, roses, salt, applause',
                    'Scroll tied with red ribbon ‚Äî gossip column, blind items',
                    'Sticky note ‚Äî "Everyone performs. Some of us admit it."'
                ],
                cocktail: 'Kir Royale ‚Äî cr√®me de cassis + champagne',
                virgin: 'Sparkling grape with cassis'
            },
            {
                id: 'hotel',
                name: 'THE HOTEL PACK ‚Äî "Room 412"',
                tagline: 'The Hallway at 3am.',
                price: '$68',
                image: null,
                featured: true,
                description: 'The complete introduction. Opens like a door. Smells like the hallway at 3am. A piece of everyone who lives here.',
                contents: [
                    'Room 412 leather key tag',
                    'Do Not Disturb sign (vintage style)',
                    'Hotel matchbook ‚Äî Est. 1943',
                    '"Hallway at 3am" signature scent',
                    'Annotated floor plan with handwritten notes',
                    'Note slipped under door: "We know you\'re in there."',
                    'ONE SAMPLE FROM EACH CHARACTER',
                    'Stack of sticky notes ‚Äî some in your handwriting, some not'
                ],
                cocktail: 'Room 412 Signature ‚Äî amber, bitter, mysterious',
                virgin: 'Bitters and soda with orange'
            }
        ];
        
        // BAR GUIDE - Full drink recipes with mixing instructions
        const barGuideDrinks = [
            {
                character: 'WIRE',
                drink: 'The Sixth Floor Toddy',
                emoji: 'üåô',
                ingredients: ['MƒÅnuka honey', 'Good whiskey (he has opinions)', 'Kawakawa leaf', 'Hot water'],
                instructions: 'Warm your glass first. Add a generous spoonful of mƒÅnuka honey. Pour whiskey over‚ÄîWire prefers something with age. Bruise the kawakawa leaf and drop it in. Top with hot (not boiling) water. Stir slowly. Drink slower.',
                story: 'What Wire drinks when the hallways get too quiet. The honey is from home. The whiskey is from somewhere that closed a long time ago.',
                virgin: 'Same, minus the whiskey. Still warms you the same way, he says.'
            },
            {
                character: 'MARISOL',
                drink: 'The Dark & Stormy',
                emoji: '‚ö°',
                ingredients: ['Dark rum', 'Ginger beer', 'Lime wedge', 'Your father\'s glass (optional)'],
                instructions: 'Fill a highball glass with ice. Pour 2oz dark rum. Top with ginger beer‚Äîthe spicier the better. Squeeze lime over the top and drop it in. Don\'t stir. Let the storm settle itself.',
                story: 'Marisol orders it like a challenge. Dark and stormy‚Äîlike the inheritance, like the hotel, like her.',
                virgin: 'Ginger lime spritz. Sharp enough to cut through any conversation.'
            },
            {
                character: 'EDDIE',
                drink: 'The Night Kitchen Michelada',
                emoji: 'üå∂Ô∏è',
                ingredients: ['Beer (Mexican lager)', 'Lime juice', 'Hot sauce (the kind that hurts)', 'Worcestershire', 'Salt rim'],
                instructions: 'Rim your glass with salt and chili powder. Add ice. Squeeze half a lime. Dash Worcestershire and hot sauce‚Äîmore than you think. Pour beer slowly. Stir once. Taste. Add more hot sauce.',
                story: 'Eddie makes this at 3am when he catches you in the kitchen. "Hair of the dog that\'s about to bite you."',
                virgin: 'Spicy tomato juice with everything but the beer. Still wakes you up.'
            },
            {
                character: 'DOTTY',
                drink: 'The Gin Fizz',
                emoji: 'üíã',
                ingredients: ['Gin', 'Lemon juice', 'Simple syrup', 'Heavy cream', 'Egg white', 'Soda water'],
                instructions: 'Dry shake (no ice) gin, lemon, syrup, cream, and egg white for 30 seconds. Your arm should hurt. Add ice, shake again. Strain into a chilled glass. Top with soda. Wait for it to rise. Admire.',
                story: 'Dotty taught three bartenders how to make this properly. None of them still work here.',
                virgin: 'Botanical lemonade fizz. Pretty enough. Not the same.'
            },
            {
                character: 'TANE',
                drink: 'The Starting Gate',
                emoji: 'üî•',
                ingredients: ['Vodka', 'Energy drink', 'Whatever you\'re running from'],
                instructions: 'Pour. Shoot. Don\'t think about it. Repeat if you dare. Tane will match you one for one. Tane will win.',
                story: 'This is the pre-game before the game before the thing you\'re going to regret.',
                virgin: 'Energy drink straight. Same chaos, less excuse.'
            },
            {
                character: 'CONSTANCE',
                drink: 'The Pimm\'s Cup',
                emoji: 'üìã',
                ingredients: ['Pimm\'s No. 1', 'Cucumber', 'Lemon', 'Strawberry', 'Mint', 'Ginger ale'],
                instructions: 'Fill a tall glass with ice. Add 2oz Pimm\'s. Top with ginger ale. Garnish with cucumber, lemon wheel, strawberry, and mint‚Äîarranged precisely. Take notes on what others ordered.',
                story: 'Constance drinks Pimm\'s because it\'s civilized. Because you can drink it in the garden and still observe.',
                virgin: 'Cucumber mint lemonade. Refreshing and deeply judgmental.'
            },
            {
                character: 'PRIYA',
                drink: 'The Trust Me',
                emoji: 'üçã',
                ingredients: ['Fernet', 'Mezcal', 'Fresh citrus', 'Amaro (to taste)', 'Proportions: classified'],
                instructions: 'She won\'t tell you. You don\'t order this‚Äîyou ask Priya what you need, and this is what you get. Trust her.',
                story: 'The bartender\'s bartender drink. Different every time. She\'s usually right.',
                virgin: 'Bitter botanical soda with grapefruit. For when you need to stay sharp.'
            },
            {
                character: 'LENNY',
                drink: 'The Irish Goodbye',
                emoji: '‚òï',
                ingredients: ['Hot coffee', 'Irish whiskey', 'Brown sugar', 'Heavy cream'],
                instructions: 'Brew strong coffee. Add 1oz whiskey and a spoonful of brown sugar. Stir until dissolved. Float cream on top by pouring over the back of a spoon. Hold with both hands. Sigh.',
                story: 'Lenny orders this after every set. "At least the coffee never heckles," he says. Every time.',
                virgin: 'Just sad coffee. He\'ll tell you the joke about that too.'
            },
            {
                character: 'CALEB',
                drink: 'The Bourbon Neat',
                emoji: 'üìù',
                ingredients: ['Bourbon', 'Glass', 'That\'s it'],
                instructions: 'Pour bourbon into glass. That\'s it. The author drinks what writers drink in movies.',
                story: 'He knows it\'s a clich√©. He wrote a short story about the clich√© once. It wasn\'t good. He still orders it.',
                virgin: 'Black coffee. He\'ll take notes on how you take yours.'
            },
            {
                character: 'RUFUS',
                drink: 'The Kir Royale',
                emoji: 'üé≠',
                ingredients: ['Cr√®me de cassis', 'Champagne (or sparkling wine)', 'Drama'],
                instructions: 'Add ¬Ωoz cr√®me de cassis to a champagne flute. Top with cold champagne. Watch the color rise. Raise your glass to everyone and no one. Never finish the first one.',
                story: '"Bubbles and darkness, darling. Like me."',
                virgin: 'Sparkling grape with cassis. Still dramatic. Still Rufus.'
            }
        ];
        
        // Populate bar guide
        const barGuideGrid = document.getElementById('bar-guide-grid');
        console.log('[Store] Bar guide grid found:', !!barGuideGrid, 'Drinks:', barGuideDrinks.length);
        if (barGuideGrid) {
            barGuideDrinks.forEach(drink => {
                const drinkEl = document.createElement('div');
                drinkEl.className = 'bar-drink-card';
                drinkEl.innerHTML = `
                    <div class="drink-header">
                        <span class="drink-emoji">${drink.emoji}</span>
                        <span class="drink-character">${drink.character}</span>
                    </div>
                    <h3 class="drink-name">${drink.drink}</h3>
                    <div class="drink-ingredients">
                        <strong>You'll need:</strong>
                        <ul>${drink.ingredients.map(i => `<li>${i}</li>`).join('')}</ul>
                    </div>
                    <div class="drink-instructions">
                        <strong>How to make it:</strong>
                        <p>${drink.instructions}</p>
                    </div>
                    <p class="drink-story"><em>${drink.story}</em></p>
                    <p class="drink-virgin"><strong>Virgin version:</strong> ${drink.virgin}</p>
                `;
                barGuideGrid.appendChild(drinkEl);
            });
            console.log('[Store] Bar guide populated with', barGuideGrid.children.length, 'drinks');
        } else {
            console.error('[Store] Bar guide grid NOT found!');
        }
        
        // Populate store grid
        storeProducts.forEach(product => {
            const productEl = document.createElement('div');
            productEl.className = 'store-product' + (product.featured ? ' featured' : '');
            productEl.dataset.productId = product.id;
            
            const contentsHtml = product.contents ? 
                `<ul class="product-contents">${product.contents.map(item => `<li>${item}</li>`).join('')}</ul>` : '';
            
            // Image gallery for products with multiple images
            let imageHtml = '';
            if (product.images && product.images.length > 1) {
                imageHtml = `
                    <div class="product-gallery">
                        <img src="${product.images[0]}" alt="${product.name}" class="gallery-main" id="gallery-${product.id}">
                        <div class="gallery-thumbs">
                            ${product.images.map((img, i) => `<img src="${img}" onclick="document.getElementById('gallery-${product.id}').src='${img}'" class="${i===0?'active':''}">`).join('')}
                        </div>
                    </div>
                `;
            } else if (product.image) {
                imageHtml = `<div class="product-image"><img src="${product.image}" alt="${product.name}"></div>`;
            } else {
                imageHtml = `<div class="product-image"><div class="product-placeholder">${product.id === 'hotel' ? 'The Complete Experience' : 'Image Coming'}</div></div>`;
            }
            
            // Character video for product
            const videoHtml = product.storeVideo ? `
                <div class="product-character-video">
                    <video autoplay loop muted playsinline>
                        <source src="${product.storeVideo}" type="video/mp4">
                    </video>
                </div>
            ` : '';
            
            productEl.innerHTML = `
                ${product.featured ? '<div class="featured-badge">‚ú¶ Available Now</div>' : ''}
                <div class="product-media">
                    ${imageHtml}
                    ${videoHtml}
                </div>
                <h3 class="product-name">${product.name}</h3>
                <p class="product-tagline">${product.tagline || ''}</p>
                <p class="product-description">${product.description}</p>
                
                <div class="product-details collapsed">
                    <h4>Contains:</h4>
                    ${contentsHtml}
                    <div class="product-cocktails">
                        <span class="cocktail-label">üç∏ ${product.cocktail}</span>
                        <span class="virgin-label">‚òï Virgin: ${product.virgin}</span>
                    </div>
                </div>
                
                <button class="details-toggle" onclick="toggleProductDetails(this)">View Contents ‚ñº</button>
                
                <div class="product-footer">
                    <span class="product-price">${product.price}</span>
                    <button class="product-btn" onclick="showStoreWaitlist('${product.name}')">Add to Cart</button>
                </div>
            `;
            storeGrid.appendChild(productEl);
        });
        
        // Toggle product details
        window.toggleProductDetails = function(btn) {
            const details = btn.previousElementSibling;
            const isCollapsed = details.classList.contains('collapsed');
            details.classList.toggle('collapsed');
            btn.textContent = isCollapsed ? 'Hide Contents ‚ñ≤' : 'View Contents ‚ñº';
        };
        
        storeBtn?.addEventListener('click', () => {
            storeModal?.classList.remove('hidden');
        });
        
        storeModal?.addEventListener('click', (e) => {
            if (e.target === storeModal) {
                storeModal.classList.add('hidden');
            }
        });
        
        // Waitlist submission (placeholder)
        window.submitWaitlist = function(form) {
            const email = form.querySelector('input[name="email"]').value;
            alert(`Thanks! We'll reach out to ${email} when the hotel opens.`);
            form.reset();
            document.querySelectorAll('.modal').forEach(m => m.classList.add('hidden'));
        };
        
        window.showStoreWaitlist = function(productName) {
            alert(`THE KNOCK is gearing up. "${productName}" will be available soon. Leave your email in the form below to be notified!`);
        };

        // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        // AUDIO SYSTEM
        // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        
        const ambientTracks = document.querySelectorAll('.ambient-track');
        const musicTrack = document.getElementById('music-main');
        const ambientSlider = document.getElementById('ambient-volume');
        const musicSlider = document.getElementById('music-volume');
        const audioToggle = document.getElementById('audio-toggle');
        
        // Music track rotation with volume normalization
        const musicTracks = [
            { src: 'assets/sounds/MataZ.wav', volumeMultiplier: 1.0 },
            { src: 'assets/sounds/beard-contest--(remastered).mp3', volumeMultiplier: 2.5 } // Boost quieter track
        ];
        let currentMusicIndex = Math.floor(Math.random() * musicTracks.length); // Start random
        
        function setMusicTrack(index) {
            if (!musicTrack) return;
            currentMusicIndex = index % musicTracks.length;
            musicTrack.src = musicTracks[currentMusicIndex].src;
            musicTrack.load();
            // Apply volume with track-specific multiplier
            updateMusicVolume(musicSlider?.value || 15);
            console.log('[Audio] Music track:', musicTracks[currentMusicIndex].src, 'multiplier:', musicTracks[currentMusicIndex].volumeMultiplier);
        }
        
        function nextMusicTrack() {
            const wasPlaying = !musicTrack?.paused;
            setMusicTrack(currentMusicIndex + 1);
            if (wasPlaying && musicTrack) {
                musicTrack.play().catch(() => {});
            }
        }
        
        // Set initial track
        setMusicTrack(currentMusicIndex);
        
        let audioStarted = false;
        let audioMuted = false;
        
        // Set initial volumes
        function updateAmbientVolume(value) {
            const vol = value / 100;
            ambientTracks.forEach(track => {
                track.volume = vol;
            });
        }
        
        function updateMusicVolume(value) {
            const baseVol = value / 100;
            const multiplier = musicTracks[currentMusicIndex]?.volumeMultiplier || 1.0;
            const vol = Math.min(1.0, baseVol * multiplier); // Cap at 1.0
            if (musicTrack) musicTrack.volume = vol;
        }
        
        // Start all audio (must be triggered by user interaction)
        function startAudio() {
            if (audioStarted) return;
            audioStarted = true;
            
            // Start ambient tracks
            ambientTracks.forEach(track => {
                track.volume = ambientSlider.value / 100;
                track.play().catch(e => console.log('Ambient blocked:', e));
            });
            
            // Start music (single track, loops)
            if (musicTrack) {
                updateMusicVolume(musicSlider?.value || 15);
                musicTrack.play().catch(e => console.log('Music blocked:', e));
            }
            
            audioMuted = false;
            audioToggle.textContent = 'üîä';
            audioToggle.classList.add('playing');
        }
        
        // Toggle mute
        function toggleAudio() {
            if (!audioStarted) {
                startAudio();
                return;
            }
            
            audioMuted = !audioMuted;
            
            // Mute/unmute all audio
            ambientTracks.forEach(track => track.muted = audioMuted);
            if (musicTrack) musicTrack.muted = audioMuted;
            
            audioToggle.textContent = audioMuted ? 'üîá' : 'üîä';
            audioToggle.classList.toggle('playing', !audioMuted);
        }
        
        // Event listeners
        audioToggle.addEventListener('click', toggleAudio);
        ambientSlider.addEventListener('input', (e) => updateAmbientVolume(e.target.value));
        musicSlider.addEventListener('input', (e) => updateMusicVolume(e.target.value));
        
        // Store modal volume controls (sync with main controls)
        const storeAmbientSlider = document.getElementById('store-ambient-volume');
        const storeMusicSlider = document.getElementById('store-music-volume');
        const storeAudioToggle = document.getElementById('store-audio-toggle');
        
        if (storeAmbientSlider) {
            storeAmbientSlider.addEventListener('input', (e) => {
                updateAmbientVolume(e.target.value);
                ambientSlider.value = e.target.value;  // Sync main slider
            });
        }
        if (storeMusicSlider) {
            storeMusicSlider.addEventListener('input', (e) => {
                updateMusicVolume(e.target.value);
                musicSlider.value = e.target.value;  // Sync main slider
            });
        }
        if (storeAudioToggle) {
            storeAudioToggle.addEventListener('click', () => {
                toggleAudio();
                storeAudioToggle.textContent = audioMuted ? 'üîá' : 'üîä';
            });
        }
        
        // Mute All buttons
        const muteAllBtn = document.getElementById('mute-all-btn');
        const storeMuteBtn = document.getElementById('store-mute-btn');
        
        function updateMuteButtons() {
            if (muteAllBtn) {
                muteAllBtn.textContent = audioMuted ? 'Unmute' : 'Mute All';
                muteAllBtn.classList.toggle('muted', audioMuted);
            }
            if (storeMuteBtn) {
                storeMuteBtn.textContent = audioMuted ? 'Unmute' : 'Mute';
                storeMuteBtn.classList.toggle('muted', audioMuted);
            }
        }
        
        muteAllBtn?.addEventListener('click', () => {
            toggleAudio();
            updateMuteButtons();
        });
        
        storeMuteBtn?.addEventListener('click', () => {
            toggleAudio();
            updateMuteButtons();
        });
        
        // Sync store sliders when store modal opens
        document.getElementById('store-btn')?.addEventListener('click', () => {
            if (storeAmbientSlider) storeAmbientSlider.value = ambientSlider.value;
            if (storeMusicSlider) storeMusicSlider.value = musicSlider.value;
            if (storeAudioToggle) storeAudioToggle.textContent = audioMuted ? 'üîá' : 'üîä';
            updateMuteButtons();
        });
        
        // Start audio on first click anywhere on page
        document.body.addEventListener('click', () => {
            if (!audioStarted) startAudio();
        }, { once: true });
        
        // Also try on any touch (mobile)
        document.body.addEventListener('touchstart', () => {
            if (!audioStarted) startAudio();
        }, { once: true });

        // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        // LANDING VIDEO LOOP WITH PAUSE ON FIRST FRAME
        // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        
        const landingVideo = document.getElementById('landing-video');
        const PAUSE_DURATION = 5000; // 5 seconds pause on first frame
        
        if (landingVideo) {
            // Start paused
            landingVideo.pause();
            landingVideo.currentTime = 0;
            
            // After pause duration, play the video
            setTimeout(() => {
                landingVideo.play();
            }, PAUSE_DURATION);
            
            // When video ends, go back to start and pause again
            landingVideo.addEventListener('ended', () => {
                landingVideo.currentTime = 0;
                landingVideo.pause();
                
                // After pause, play again
                setTimeout(() => {
                    landingVideo.play();
                }, PAUSE_DURATION);
            });
        }

        // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        // SESSION MANAGER & WRITING ENGINE
        // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        
        const sessionManager = getSessionManager();
        
        // UI Elements
        const endSessionBtn = document.getElementById('end-session-btn');
        const sessionIndicator = document.getElementById('session-indicator');
        const sessionCount = document.getElementById('session-count');
        const sessionPlural = document.getElementById('session-plural');
        const writingModal = document.getElementById('writing-modal');
        const writingClose = document.getElementById('writing-close');
        const writingLoading = document.getElementById('writing-loading');
        const writingSuccess = document.getElementById('writing-success');
        const writingError = document.getElementById('writing-error');
        const chapterContent = document.getElementById('chapter-content');
        const chapterWordCount = document.getElementById('chapter-word-count');
        const chapterCharacters = document.getElementById('chapter-characters');
        const copyChapterBtn = document.getElementById('copy-chapter-btn');
        const newSessionBtn = document.getElementById('new-session-btn');
        const retryChapterBtn = document.getElementById('retry-chapter-btn');
        
        // Update session UI based on conversation count
        function updateSessionUI() {
            const count = sessionManager.getConversationCount();
            
            if (count > 0) {
                endSessionBtn?.classList.remove('hidden');
                sessionIndicator?.classList.remove('hidden');
                sessionCount.textContent = count;
                sessionPlural.textContent = count === 1 ? '' : 's';
            } else {
                endSessionBtn?.classList.add('hidden');
                sessionIndicator?.classList.add('hidden');
            }
        }
        
        // Listen for new conversations being stored
        window.addEventListener('hearsay-conversation-stored', (e) => {
            console.log('[Session] Conversation stored:', e.detail);
            updateSessionUI();
        });
        
        // Initial UI update
        updateSessionUI();
        
        // End Session button click
        endSessionBtn?.addEventListener('click', async () => {
            if (!sessionManager.hasConversations()) {
                alert('No conversations yet. Talk to someone first!');
                return;
            }
            
            // Show writing modal in loading state
            writingLoading.classList.remove('hidden');
            writingSuccess.classList.add('hidden');
            writingError.classList.add('hidden');
            writingModal.classList.remove('hidden');
            
            try {
                // Get session data for Writing Engine
                const sessionData = sessionManager.exportForWritingEngine();
                console.log('[WritingEngine] Generating chapter from:', sessionData);
                
                // Get previous chapters for RAG context (continuity)
                const previousChapters = getPreviousChaptersForContext(3);
                console.log('[WritingEngine] Including', previousChapters.length, 'previous chapters for context');
                
                // Call Writing Engine API
                const response = await fetch('/api/writing-engine/generate', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        sessionId: sessionData.sessionId,
                        transcripts: sessionData.transcripts,
                        previousChapters: previousChapters,
                        chapterLength: 'medium'
                    })
                });
                
                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.detail || 'Failed to generate chapter');
                }
                
                const chapter = await response.json();
                console.log('[WritingEngine] Chapter generated:', chapter);
                
                // Show success state
                writingLoading.classList.add('hidden');
                writingSuccess.classList.remove('hidden');
                
                // Display chapter
                chapterContent.innerHTML = chapter.content
                    .split('\n\n')
                    .map(p => `<p>${p}</p>`)
                    .join('');
                chapterWordCount.textContent = chapter.wordCount;
                chapterCharacters.textContent = chapter.charactersIncluded.join(', ');
                
                // Store chapter in localStorage
                const chaptersKey = 'hearsay_chapters';
                const chapters = JSON.parse(localStorage.getItem(chaptersKey) || '[]');
                chapters.push({
                    ...chapter,
                    userSessionId: sessionData.sessionId
                });
                localStorage.setItem(chaptersKey, JSON.stringify(chapters));
                
                // Update chapters button visibility
                updateChaptersButton();
                
            } catch (error) {
                console.error('[WritingEngine] Error:', error);
                
                // Show error state
                writingLoading.classList.add('hidden');
                writingError.classList.remove('hidden');
                document.getElementById('writing-error-message').textContent = error.message;
            }
        });
        
        // Copy chapter to clipboard
        copyChapterBtn?.addEventListener('click', () => {
            const text = chapterContent.innerText;
            navigator.clipboard.writeText(text).then(() => {
                copyChapterBtn.textContent = 'Copied!';
                setTimeout(() => {
                    copyChapterBtn.textContent = 'Copy to Clipboard';
                }, 2000);
            });
        });
        
        // Start new session
        newSessionBtn?.addEventListener('click', () => {
            sessionManager.endSession();
            writingModal.classList.add('hidden');
            updateSessionUI();
            // Optionally reload to clear everything
            // window.location.reload();
        });
        
        // Retry chapter generation
        retryChapterBtn?.addEventListener('click', () => {
            endSessionBtn.click();
        });
        
        // Close writing modal
        writingClose?.addEventListener('click', () => {
            writingModal.classList.add('hidden');
        });
        
        writingModal?.addEventListener('click', (e) => {
            if (e.target === writingModal) {
                writingModal.classList.add('hidden');
            }
        });
        
        // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        // CHAPTERS PAGE
        // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        
        const chaptersBtn = document.getElementById('chapters-btn');
        const chaptersModal = document.getElementById('chapters-modal');
        const chaptersClose = document.getElementById('chapters-close');
        const chaptersEmpty = document.getElementById('chapters-empty');
        const chaptersList = document.getElementById('chapters-list');
        const chapterReader = document.getElementById('chapter-reader');
        const backToChapters = document.getElementById('back-to-chapters');
        const readerTitle = document.getElementById('reader-title');
        const readerDate = document.getElementById('reader-date');
        const readerWords = document.getElementById('reader-words');
        const readerCharacters = document.getElementById('reader-characters');
        const readerContent = document.getElementById('reader-content');
        const readerCopyBtn = document.getElementById('reader-copy-btn');
        
        // Get all chapters from localStorage
        function getStoredChapters() {
            try {
                return JSON.parse(localStorage.getItem('hearsay_chapters') || '[]');
            } catch (e) {
                console.error('[Chapters] Error reading chapters:', e);
                return [];
            }
        }
        
        // Get previous chapters for RAG context (returns last N chapter contents)
        function getPreviousChaptersForContext(limit = 3) {
            const chapters = getStoredChapters();
            return chapters.slice(-limit).map(c => c.content);
        }
        
        // Update chapters button visibility
        function updateChaptersButton() {
            const chapters = getStoredChapters();
            if (chapters.length > 0) {
                chaptersBtn?.classList.remove('hidden');
            } else {
                chaptersBtn?.classList.add('hidden');
            }
        }
        
        // Render chapters list
        function renderChaptersList() {
            const chapters = getStoredChapters();
            
            if (chapters.length === 0) {
                chaptersEmpty?.classList.remove('hidden');
                chaptersList?.classList.add('hidden');
                return;
            }
            
            chaptersEmpty?.classList.add('hidden');
            chaptersList?.classList.remove('hidden');
            chapterReader?.classList.add('hidden');
            
            chaptersList.innerHTML = chapters.map((chapter, index) => {
                const date = new Date(chapter.generatedAt).toLocaleDateString('en-US', {
                    month: 'short',
                    day: 'numeric',
                    year: 'numeric'
                });
                const characters = chapter.charactersIncluded?.join(', ') || 'Unknown';
                const preview = chapter.content?.substring(0, 150) + '...' || '';
                
                return `
                    <div class="chapter-card" data-chapter-index="${index}">
                        <div class="chapter-card-header">
                            <h3>Chapter ${index + 1}</h3>
                            <span class="chapter-date">${date}</span>
                        </div>
                        <p class="chapter-preview">${preview}</p>
                        <div class="chapter-card-meta">
                            <span>${chapter.wordCount || '?'} words</span>
                            <span class="meta-sep">‚Ä¢</span>
                            <span>${characters}</span>
                        </div>
                    </div>
                `;
            }).join('');
            
            // Add click handlers
            chaptersList.querySelectorAll('.chapter-card').forEach(card => {
                card.addEventListener('click', () => {
                    const index = parseInt(card.dataset.chapterIndex);
                    openChapter(index);
                });
            });
        }
        
        // Open a specific chapter in the reader
        function openChapter(index) {
            const chapters = getStoredChapters();
            const chapter = chapters[index];
            
            if (!chapter) return;
            
            chaptersList?.classList.add('hidden');
            chapterReader?.classList.remove('hidden');
            
            readerTitle.textContent = `Chapter ${index + 1}`;
            readerDate.textContent = new Date(chapter.generatedAt).toLocaleDateString('en-US', {
                weekday: 'long',
                month: 'long',
                day: 'numeric',
                year: 'numeric'
            });
            readerWords.textContent = chapter.wordCount || '?';
            readerCharacters.textContent = chapter.charactersIncluded?.join(', ') || 'Unknown';
            
            // Render content as paragraphs
            readerContent.innerHTML = chapter.content
                .split('\n\n')
                .filter(p => p.trim())
                .map(p => `<p>${p}</p>`)
                .join('');
        }
        
        // Chapters button click
        chaptersBtn?.addEventListener('click', () => {
            renderChaptersList();
            chaptersModal?.classList.remove('hidden');
        });
        
        // Back to chapters list
        backToChapters?.addEventListener('click', () => {
            chapterReader?.classList.add('hidden');
            chaptersList?.classList.remove('hidden');
        });
        
        // Copy from reader
        readerCopyBtn?.addEventListener('click', () => {
            const text = readerContent.innerText;
            navigator.clipboard.writeText(text).then(() => {
                readerCopyBtn.textContent = 'Copied!';
                setTimeout(() => {
                    readerCopyBtn.textContent = 'Copy to Clipboard';
                }, 2000);
            });
        });
        
        // Close chapters modal
        chaptersClose?.addEventListener('click', () => {
            chaptersModal?.classList.add('hidden');
        });
        
        chaptersModal?.addEventListener('click', (e) => {
            if (e.target === chaptersModal) {
                chaptersModal?.classList.add('hidden');
            }
        });
        
        // Initialize chapters button
        updateChaptersButton();

        // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        // INIT
        // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        
        // Expose for debugging
        window.hearsay = { stateMachine, compositor, simli, config, characters, platform, experience, sessionManager };
        console.log(`${platform.name} ‚Äî ${experience.name} initialized`);
    </script>
</body>
</html>
