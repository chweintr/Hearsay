<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Room 412 — HEARSAY</title>
    <meta name="description" content="Stories through the door. A HEARSAY experience.">
    
    <link rel="stylesheet" href="styles.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=EB+Garamond:ital,wght@0,400;0,500;0,600;1,400;1,500&family=Cinzel:wght@400;500;600&display=swap" rel="stylesheet">
    
    <!-- Simli Widget SDK -->
    <script src="https://cdn.simli.com/widget/simli-widget.umd.min.js" defer></script>
</head>
<body>
    <!-- ═══════════════════════════════════════════════════════════════════════
         LANDING PAGE - Character Selection
         ═══════════════════════════════════════════════════════════════════════ -->
    <div id="landing-page" class="page active">
        <div class="landing-background">
            <video id="landing-video" class="landing-bg-video" autoplay muted playsinline>
                <source src="assets/videos/The_Knock_Background.mp4" type="video/mp4">
            </video>
            <div class="landing-overlay"></div>
        </div>
        
        <div class="landing-content">
            <div class="landing-spacer"></div>
            
            <div class="character-gallery" id="character-gallery">
                <!-- Characters injected by JS -->
            </div>
        </div>
    </div>

    <!-- ═══════════════════════════════════════════════════════════════════════
         EXPERIENCE PAGE - Peephole Interface
         ═══════════════════════════════════════════════════════════════════════ -->
    <div id="experience-page" class="page">
        <div id="hearsay-app">
            <!-- Layer 0: Background / Ambient -->
            <div id="layer-background" class="video-layer">
                <video id="video-idle" loop muted playsinline>
                    <source src="assets/videos/idle_loop.mp4" type="video/mp4">
                </video>
            </div>

            <!-- Layer 1: Transition Videos -->
            <div id="layer-transition" class="video-layer hidden">
                <video id="video-transition" playsinline></video>
            </div>

            <!-- Layer 2: Simli Widget Container -->
            <div id="layer-simli" class="video-layer hidden">
                <div id="simli-mount"></div>
            </div>

            <!-- Layer 3: Peephole Frame -->
            <div id="layer-peephole" class="overlay-layer">
                <div id="peephole-mask">
                    <div id="peephole-glass"></div>
                </div>
            </div>

            <!-- Layer 4: Door overlay -->
            <div id="layer-door-overlay" class="overlay-layer">
                <img src="assets/images/door_ring.png" alt="" id="door-ring">
            </div>

            <!-- Vignette -->
            <div id="vignette-overlay"></div>
        </div>

        <!-- Experience Controls -->
        <div id="experience-controls" class="experience-ui">
            <button id="btn-dismiss" class="btn-dismiss" disabled>Send Away</button>
            <button id="btn-back" class="btn-back">← Back</button>
        </div>

        <!-- Character info overlay -->
        <div id="character-info" class="character-info">
            <span id="current-character-name"></span>
            <span id="current-character-role"></span>
        </div>
    </div>

    <!-- Audio elements -->
    <audio id="audio-knock" preload="auto">
        <source src="assets/sounds/knock.mp3" type="audio/mpeg">
    </audio>
    <audio id="audio-ambient" loop preload="auto">
        <source src="assets/sounds/ambient.mp3" type="audio/mpeg">
    </audio>

    <!-- ═══════════════════════════════════════════════════════════════════════
         APPLICATION LOGIC
         ═══════════════════════════════════════════════════════════════════════ -->
    <script type="module">
        import { config, characters, platform, experience } from './config.js';
        import { StateMachine } from './state-machine.js';
        import { Compositor } from './compositor.js';
        import { SimliIntegration } from './simli-integration.js';

        // ─────────────────────────────────────────────────────────────────────
        // PAGE MANAGEMENT
        // ─────────────────────────────────────────────────────────────────────
        
        const landingPage = document.getElementById('landing-page');
        const experiencePage = document.getElementById('experience-page');
        
        function showLanding() {
            landingPage.classList.add('active');
            experiencePage.classList.remove('active');
        }
        
        function showExperience() {
            landingPage.classList.remove('active');
            experiencePage.classList.add('active');
        }

        // ─────────────────────────────────────────────────────────────────────
        // CHARACTER GALLERY
        // ─────────────────────────────────────────────────────────────────────
        
        const gallery = document.getElementById('character-gallery');
        
        Object.entries(characters).forEach(([key, character]) => {
            const card = document.createElement('div');
            card.className = 'character-card';
            card.dataset.character = key;
            
            // Check if we have a preview video
            const videoSrc = character.previewVideo || 
                (character.idleToActive && character.idleToActive.length > 0 ? character.idleToActive[0] : null);
            
            card.innerHTML = `
                <div class="character-circle">
                    ${videoSrc ? `
                        <video class="character-preview" loop muted playsinline autoplay>
                            <source src="${videoSrc}" type="video/mp4">
                        </video>
                    ` : `
                        <div class="character-placeholder"></div>
                    `}
                    <div class="character-circle-border"></div>
                </div>
                <span class="character-name">${character.name}</span>
                <span class="character-role">${character.role}</span>
            `;
            
            card.addEventListener('click', () => {
                enterExperience(key);
            });
            
            // Play video on hover
            const video = card.querySelector('video');
            if (video) {
                video.play().catch(() => {});
            }
            
            gallery.appendChild(card);
        });

        // ─────────────────────────────────────────────────────────────────────
        // CORE SYSTEMS
        // ─────────────────────────────────────────────────────────────────────
        
        const stateMachine = new StateMachine();
        const compositor = new Compositor(stateMachine);
        const simli = new SimliIntegration(stateMachine, config);
        
        // UI Elements
        const dismissBtn = document.getElementById('btn-dismiss');
        const backBtn = document.getElementById('btn-back');
        const charNameEl = document.getElementById('current-character-name');
        const charRoleEl = document.getElementById('current-character-role');

        // ─────────────────────────────────────────────────────────────────────
        // ENTER EXPERIENCE
        // ─────────────────────────────────────────────────────────────────────
        
        function enterExperience(characterKey) {
            const character = characters[characterKey];
            if (!character) return;
            
            // Update character info display
            charNameEl.textContent = character.name;
            charRoleEl.textContent = character.role;
            
            // Switch to experience view
            showExperience();
            
            // Start the experience - summon character
            setTimeout(() => {
                stateMachine.summonCharacter(characterKey);
            }, 500);
        }

        // ─────────────────────────────────────────────────────────────────────
        // CONTROLS
        // ─────────────────────────────────────────────────────────────────────
        
        dismissBtn.addEventListener('click', () => {
            if (stateMachine.currentState === 'active') {
                stateMachine.dismissCharacter();
            }
        });
        
        backBtn.addEventListener('click', () => {
            // If in conversation, dismiss first
            if (stateMachine.currentState === 'active') {
                stateMachine.dismissCharacter();
            }
            // Go back to landing after a moment
            setTimeout(() => {
                stateMachine.reset();
                showLanding();
            }, 300);
        });

        // ─────────────────────────────────────────────────────────────────────
        // STATE UPDATES
        // ─────────────────────────────────────────────────────────────────────
        
        stateMachine.on('stateChange', ({ to }) => {
            dismissBtn.disabled = to !== 'active';
        });
        
        stateMachine.on('characterDismissed', () => {
            // Return to landing after character leaves
            setTimeout(() => {
                showLanding();
            }, 500);
        });

        // ─────────────────────────────────────────────────────────────────────
        // INIT
        // ─────────────────────────────────────────────────────────────────────
        
        // ─────────────────────────────────────────────────────────────────────
        // LANDING VIDEO LOOP WITH PAUSE ON FIRST FRAME
        // ─────────────────────────────────────────────────────────────────────
        
        const landingVideo = document.getElementById('landing-video');
        const PAUSE_DURATION = 5000; // 5 seconds pause on first frame
        
        if (landingVideo) {
            // Start paused
            landingVideo.pause();
            landingVideo.currentTime = 0;
            
            // After pause duration, play the video
            setTimeout(() => {
                landingVideo.play();
            }, PAUSE_DURATION);
            
            // When video ends, go back to start and pause again
            landingVideo.addEventListener('ended', () => {
                landingVideo.currentTime = 0;
                landingVideo.pause();
                
                // After pause, play again
                setTimeout(() => {
                    landingVideo.play();
                }, PAUSE_DURATION);
            });
        }

        // ─────────────────────────────────────────────────────────────────────
        // INIT
        // ─────────────────────────────────────────────────────────────────────
        
        // Expose for debugging
        window.hearsay = { stateMachine, compositor, simli, config, characters, platform, experience };
        console.log(`${platform.name} — ${experience.name} initialized`);
    </script>
</body>
</html>
